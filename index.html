<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>🔥 多关键词内容生成工具</title>
  <style>
    /* 🌈 Reset cơ bản */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Microsoft YaHei", "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #e0e7ff, #f5f3ff);
      color: #333;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 50px 20px;
    }

    h1 {
      text-align: center;
      font-size: 26px;
      color: #111827;
      margin-bottom: 25px;
      letter-spacing: 1px;
    }

    .container {
      background: #fff;
      width: 100%;
      max-width: 900px;
      border-radius: 16px;
      padding: 35px 40px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      animation: fadeIn 0.6s ease;
    }

    label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
      color: #374151;
      font-size: 15px;
    }

    textarea, input {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 15px;
      transition: all 0.2s ease;
    }

    textarea:focus, input:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
      outline: none;
    }

    button {
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.3px;
      transition: transform 0.2s ease, background 0.2s ease;
    }

    button:hover {
      transform: scale(1.05);
      background: linear-gradient(135deg, #4338ca, #6366f1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
      font-size: 14px;
    }

    th {
      background: #eef2ff;
      color: #312e81;
      font-weight: 600;
      padding: 12px;
      text-align: left;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
      vertical-align: top;
    }

    tr:hover {
      background: #f9fafb;
    }

    .btn-small {
      padding: 5px 10px;
      font-size: 13px;
      border-radius: 6px;
      border: none;
      margin: 2px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .copy {
      background: #10b981;
      color: #fff;
    }

    .copy:hover {
      background: #059669;
    }

    .result {
      margin-top: 20px;
    }

    /* 🔄 Loading style */
    .loading {
      text-align: center;
      color: #6b7280;
      font-size: 15px;
      padding: 20px 0;
    }

    /* 🎞️ Hiệu ứng xuất hiện */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* 📱 Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 25px;
      }
      table {
        font-size: 13px;
      }
      th, td {
        padding: 8px;
      }
    }

    .copy-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #059669;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      animation: fadeInOut 2s ease forwards;
      z-index: 1000;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(20px); }
      20% { opacity: 1; transform: translateY(0); }
      80% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-20px); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔥 多关键词内容生成工具</h1>

    <label>主关键词（每行一个）:</label>
    <textarea id="keywords" rows="6" placeholder="例：线上赌博app&#10;PG电子平台&#10;在线澳门赌博"></textarea>

    <label>网址（默认：http://191.run）:</label>
    <input id="url" type="text" placeholder="http://191.run" value="http://191.run">

    <button onclick="generateContent()">🚀 生成内容</button>

    <div id="result" class="result"></div>
  </div>

  <script>
    const SITE_BASE = 'https://sites.google.com/view/';
    let currentSiteId = '';
    
    function generateRandomId(length = 10) {
      const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }
    
    function generateNewSiteId() {
      currentSiteId = generateRandomId(10);
      document.getElementById('siteIdDisplay').textContent = currentSiteId;
      document.getElementById('siteUrlDisplay').textContent = SITE_BASE + currentSiteId;
      document.getElementById('currentSiteId').textContent = `当前 ID: ${currentSiteId}`;
      document.getElementById('siteIdCopyArea').style.display = 'block';
    }
    
    // copy the 10-char site id for a specific row
    function copySiteId(index) {
      const item = (window.generatedData && window.generatedData[index]) || {};
      const id = item.site_id || generateRandomId(10);
      copyText(id).then(() => markCopied(index, 'id'));
    }

    // copy the full Google Sites URL for a specific row
    function copySiteUrl(index) {
      const item = (window.generatedData && window.generatedData[index]) || {};
      const url = SITE_BASE + (item.site_id || generateRandomId(10));
      copyText(url).then(() => markCopied(index, 'siteurl'));
    }

    async function generateContent() {
      const keywords = document.getElementById("keywords").value.trim();
      const url = document.getElementById("url").value.trim() || "http://191.run";
      const resultDiv = document.getElementById("result");
      
      // Generate new site ID when generating content
      currentSiteId = generateRandomId(10);

      if (!keywords) {
        alert("请输入至少一个主关键词！");
        return;
      }

      resultDiv.innerHTML = `<p class="loading">⏳ 正在生成中，请稍候...</p>`;

      try {
        const response = await fetch("https://backend-googlesite-create-content1.onrender.com/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ keywords, url })
        });

        if (!response.ok) throw new Error("服务器返回错误：" + response.status);

  const raw = await response.json();
  // assign a unique 10-char site_id to each item
  const data = (Array.isArray(raw) ? raw : []).map(item => ({ ...item, site_id: generateRandomId(10) }));
  // save globally for copy handlers
  window.generatedData = data;
  // reset per-row copy state
  window.copyState = [];
  window.providedUrl = url;
  renderTable(data);
      } catch (err) {
        resultDiv.innerHTML = `<p style="color:red;">❌ 生成出错：${err.message}</p>`;
      }
    }

    function renderTable(data) {
      const resultDiv = document.getElementById("result");
      let html = `
        <table>
          <thead>
            <tr>
              <th>已完成</th>
              <th>STT</th>
              <th>主关键词</th>
              <th>相关关键词</th>
              <th>内容</th>
              <th>Bing搜索链接</th>
              <th>Google Site</th>
            </tr>
          </thead>
          <tbody>
      `;

      data.forEach((item, index) => {
        if (item.error) {
          html += `
            <tr>
              <td><input type="checkbox" id="done-${index}" disabled ${ (window.copyState && window.copyState[index] && window.copyState[index].size >= 5) ? 'checked' : '' }></td>
              <td>${index + 1}</td>
              <td>${item.main}</td>
              <td colspan="4" style="color:red;">错误: ${item.error}</td>
            </tr>
          `;
        } else {
          html += `
            <tr>
              <td><input type="checkbox" id="done-${index}" disabled ${ (window.copyState && window.copyState[index] && window.copyState[index].size >= 5) ? 'checked' : '' }></td>
              <td>${index + 1}</td>
              <td>${item.main}</td>
              <td>
                <button class="btn-small copy" onclick="copyRelatedText(${index})">复制相关关键词</button>
              </td>
              <td>
                <button class="btn-small copy" onclick="copyContent(${index})">复制内容</button>
              </td>
              <td>
                <button class="btn-small copy" onclick="copyBing(${index}, '${escapeJs(item.bing_url)}')">复制链接</button>
              </td>
              <td>
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <button class="btn-small copy" onclick="copySiteId(${index})">复制 ID</button>
                  <button class="btn-small copy" onclick="copySiteUrl(${index})">复制完整链接</button>
                </div>
              </td>
            </tr>
          `;
        }
      });

      html += "</tbody></table>";
      resultDiv.innerHTML = html;
    }

    // --- helper escaping used in templates ---
    function escapeHtml(str){
      if(!str && str !== 0) return '';
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
    function escapeJs(str){
      if(!str && str !== 0) return '';
      return String(str).replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/\n/g,' ');
    }

    function copyRelatedText(index) {
      const item = (window.generatedData && window.generatedData[index]) || {};
      const related = (item.related || []).join('，');
      const siteUrl = SITE_BASE + (item.site_id || generateRandomId(10));
      copyHtmlContent(related, siteUrl).then(() => markCopied(index, 'related'));
    }

    function copyContent(index) {
      const item = (window.generatedData && window.generatedData[index]) || {};
      const content = item.content || '';
      // For content, attach the user-provided URL (from the form) — not the Google Site link
      const siteUrl = item.site_url || window.providedUrl || '';
      // remove leading scheme (http:// or https://) from the displayed text inside the content
      const displayContent = String(content).replace(/https?:\/\//g, '');
      copyHtmlContent(displayContent, siteUrl).then(() => markCopied(index, 'content'));
    }

    function copyBing(index, bingUrl) {
      // copy plain bing url text and mark
      copyText(bingUrl).then(() => markCopied(index, 'bing'));
    }

    function markCopied(index, action) {
      if (!window.copyState) window.copyState = [];
      if (!window.copyState[index]) window.copyState[index] = new Set();
      window.copyState[index].add(action);
      updateRowCheckbox(index);
    }

    function updateRowCheckbox(index) {
      const set = (window.copyState && window.copyState[index]);
      const done = set && set.size >= 5; // related, content, bing, id, siteurl
      const cb = document.getElementById('done-' + index);
      if (cb) cb.checked = !!done;
    }

    function showToast(message) {
      // Remove any existing toast
      const existingToast = document.querySelector('.copy-toast');
      if (existingToast) {
        existingToast.remove();
      }

      // Create and show new toast
      const toast = document.createElement('div');
      toast.className = 'copy-toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      // Remove toast after animation
      setTimeout(() => {
        toast.remove();
      }, 2000);
    }

    function copyHtmlContent(text, url) {
      // Create both plain text and HTML versions for the clipboard
      const plainText = text;
      const html = `<a href="${url}">${text}</a>`;

      try {
        // Create a clipboard item with both formats
        const clipboardItem = new ClipboardItem({
          'text/plain': new Blob([plainText], { type: 'text/plain' }),
          'text/html': new Blob([html], { type: 'text/html' })
        });

        return navigator.clipboard.write([clipboardItem]).then(() => {
          showToast("✅ 已复制");
        }).catch(() => {
          // Fallback to basic text copy
          return navigator.clipboard.writeText(plainText).then(() => showToast("✅ 已复制"));
        });
      } catch (err) {
        // Ultimate fallback
        return navigator.clipboard.writeText(plainText).then(() => showToast("✅ 已复制"));
      }
    }

    function copyText(text) {
      try {
        return navigator.clipboard.writeText(text).then(() => {
          showToast("✅ 已复制");
        });
      } catch (err) {
        // try synchronous fallback
        try { document.execCommand && document.execCommand('copy'); } catch (e) {}
        showToast("✅ 已复制");
        return Promise.resolve();
      }
    }
  // 初始化：不需要生成全局 Site ID anymore; each row has its own site_id
  </script>
</body>
</html>
